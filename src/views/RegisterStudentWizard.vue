<template>
  <div class="card">
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —à–∞–≥–æ–≤ -->
    <div class="steps">
      <div :class="['step', step===1 && 'active']">
        <span class="icon">üë§</span>
        <span>–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</span>
      </div>
      <div class="line"></div>
      <div :class="['step', step===2 && 'active']">
        <span class="icon">üìÑ</span>
        <span>–î–æ–∫—É–º–µ–Ω—Ç—ã</span>
      </div>
    </div>

    <!-- –®–∞–≥ 1 -->
    <div v-if="step===1">
      <h3>–®–∞–≥ 1 ‚Äî –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>

      <h4>–†–æ–¥–∏—Ç–µ–ª—å / –ó–∞–∫–æ–Ω–Ω—ã–π –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å</h4>
      <div class="row-two">
        <div>
          <label>–ö—Ç–æ –∑–∞–ø–æ–ª–Ω—è–µ—Ç</label>
          <div class="radio-row">
            <label>
              <input type="radio" value="parent" v-model="guardianType" />
              –†–æ–¥–∏—Ç–µ–ª—å</label>
            <label><input type="radio" value="representative" v-model="guardianType" />
              –ó–∞–∫–æ–Ω–Ω—ã–π –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å</label>
          </div>

          <label>–§–∞–º–∏–ª–∏—è</label>
          <input
              v-model="g.last_name"
              :class="['input', errors['guardian.last_name'] && 'error']"
          />
          <small class="error" v-if="errors['guardian.last_name']">{{ errors['guardian.last_name'] }}</small>

          <label>–ò–º—è</label>
          <input
              v-model="g.first_name"
              :class="['input', errors['guardian.first_name'] && 'error']"
          />
          <small class="error" v-if="errors['guardian.first_name']">{{ errors['guardian.first_name'] }}</small>

          <label>–û—Ç—á–µ—Å—Ç–≤–æ</label>
          <input
              v-model="g.middle_name"
              :class="['input', errors['guardian.middle_name'] && 'error']"
          />
          <small class="error" v-if="errors['guardian.middle_name']">{{ errors['guardian.middle_name'] }}</small>

          <label>–ü–æ–ª</label>
          <select
              v-model="g.sex"
              :class="['input', errors['guardian.sex'] && 'error']"
          >
            <option value="male">–º—É–∂—Å–∫–æ–π</option>
            <option value="female">–∂–µ–Ω—Å–∫–∏–π</option>
          </select>
          <small class="error" v-if="errors['guardian.sex']">{{ errors['guardian.sex'] }}</small>

          <label>–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ</label>
          <input
              v-model="g.citizenship"
              :class="['input', errors['guardian.citizenship'] && 'error']"
          />
          <small class="error" v-if="errors['guardian.citizenship']">{{ errors['guardian.citizenship'] }}</small>
        </div>
        <div>
          <label>PIN (14 —Ü–∏—Ñ—Ä)</label>
          <input
              v-model="g.pin"
              :class="['input', errors['guardian.pin'] && 'error']"
          />
          <small class="error" v-if="errors['guardian.pin']">{{ errors['guardian.pin'] }}</small>

          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input
              v-model="g.phone"
              :class="['input', errors['guardian.phone'] && 'error']"
          />
          <small class="error" v-if="errors['guardian.phone']">{{ errors['guardian.phone'] }}</small>

          <label>–ê–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è</label>
          <input
              v-model="g.address"
              :class="['input', errors['guardian.address'] && 'error']"
          />
          <small class="error" v-if="errors['guardian.address']">{{ errors['guardian.address'] }}</small>

          <label>Email</label>
          <input
              v-model="g.email"
              :class="['input', errors['guardian.email'] && 'error']"
          />
          <small class="error" v-if="errors['guardian.email']">{{ errors['guardian.email'] }}</small>
        </div>
      </div>

      <h4>–î–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∞</h4>
      <div class="row-two">
        <div>
          <label>–§–∞–º–∏–ª–∏—è</label>
          <input
              v-model="s.last_name"
              :class="['input', errors['student.last_name'] && 'error']"
          />
          <small class="error" v-if="errors['student.last_name']">{{ errors['student.last_name'] }}</small>

          <label>–ò–º—è</label>
          <input
              v-model="s.first_name"
              :class="['input', errors['student.first_name'] && 'error']"
          />
          <small class="error" v-if="errors['student.first_name']">{{ errors['student.first_name'] }}</small>

          <label>–û—Ç—á–µ—Å—Ç–≤–æ</label>
          <input
              v-model="s.middle_name"
              :class="['input', errors['student.middle_name'] && 'error']"
          />
          <small class="error" v-if="errors['student.middle_name']">{{ errors['student.middle_name'] }}</small>

          <label>PIN —É—á–µ–Ω–∏–∫–∞ (14 —Ü–∏—Ñ—Ä)</label>
          <input
              v-model="s.pin"
              :class="['input', errors['student.pin'] && 'error']"
          />
          <small class="error" v-if="errors['student.pin']">{{ errors['student.pin'] }}</small>

          <label>–ü–æ–ª</label>
          <select
              v-model="s.sex"
              :class="['input', errors['student.sex'] && 'error']"
          >
            <option value="male">–º—É–∂—Å–∫–æ–π</option>
            <option value="female">–∂–µ–Ω—Å–∫–∏–π</option>
          </select>
          <small class="error" v-if="errors['student.sex']">{{ errors['student.sex'] }}</small>

          <label>–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ</label>
          <input
              v-model="s.citizenship"
              :class="['input', errors['student.citizenship'] && 'error']"
          />
          <small class="error" v-if="errors['student.citizenship']">{{ errors['student.citizenship'] }}</small>

          <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
          <input
              v-model="s.birth_date"
              placeholder="YYYY-MM-DD"
              :class="['input', errors['student.birth_date'] && 'error']"
          />
          <small class="error" v-if="errors['student.birth_date']">{{ errors['student.birth_date'] }}</small>
        </div>
        <div>

          <label>–£—Ä–æ–≤–µ–Ω—å (–∫–ª–∞—Å—Å)</label>
          <select
              v-model.number="level_id"
              :class="['input', errors['student.level_id'] && 'error']"
          >
            <option :value="0">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å ‚Äî</option>
            <option v-for="lv in levels" :key="lv.id" :value="lv.id">
              {{ lv.title || (lv.number + ' –∫–ª–∞—Å—Å') }}
            </option>
          </select>
          <small class="error" v-if="errors['student.level_id']">{{ errors['student.level_id'] }}</small>

          <label>–§–æ—Ç–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input
              type="file"
              accept="image/jpeg,image/jpg,image/png"
              @change="handlePhotoChange"
              :class="['input', errors['student_photo'] && 'error']"
          />
          <small class="error" v-if="errors['student_photo']">{{ errors['student_photo'] }}</small>
          <div v-if="studentPhotoPreview" style="margin-top: 8px;">
            <img :src="studentPhotoPreview" alt="Preview" style="max-width: 150px; max-height: 150px; border-radius: 8px;" />
          </div>

          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input
              v-model="s.phone"
              :class="['input', errors['student.phone'] && 'error']"
          />
          <small class="error" v-if="errors['student.phone']">{{ errors['student.phone'] }}</small>

          <label>–ü–∞—Ä–æ–ª—å</label>
          <input
              type="password"
              v-model="s.password"
              :class="['input', errors['student.password'] && 'error']"
          />
          <small class="error" v-if="errors['student.password']">{{ errors['student.password'] }}</small>

          <label>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</label>
          <input
              type="password"
              v-model="s.password_confirmation"
              :class="['input', errors['student.password_confirmation'] && 'error']"
          />
          <small class="error" v-if="errors['student.password_confirmation']">{{ errors['student.password_confirmation'] }}</small>

          <label>Email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input
              v-model="s.email"
              :class="['input', errors['student.email'] && 'error']"
          />
          <small class="error" v-if="errors['student.email']">{{ errors['student.email'] }}</small>
        </div>
      </div>

      <div class="actions">
        <button @click="goStep2">–î–∞–ª–µ–µ ‚Üí –î–æ–∫—É–º–µ–Ω—Ç—ã</button>
      </div>
      <div v-if="error1" class="error">{{ error1 }}</div>
    </div>

    <!-- –®–∞–≥ 2 -->
    <div v-else>
      <h3>–®–∞–≥ 2 ‚Äî –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (JPEG/JPG/PDF)</h3>

      <div class="row-two">
        <div>
          <label>–ó–∞—è–≤–ª–µ–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—è/–∑–∞–∫–æ–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è</label>
          <input type="file" @change="pick('guardian_application',$event)" accept=".jpg,.jpeg,.pdf" />
          <label>–ö–æ–ø–∏—è —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –æ —Ä–æ–∂–¥–µ–Ω–∏–∏</label>
          <input type="file" @change="pick('birth_certificate',$event)" accept=".jpg,.jpeg,.pdf" />
          <label>–î–æ–∫—É–º–µ–Ω—Ç —Å PIN-–∫–æ–¥–æ–º —Å—Ç—É–¥–µ–Ω—Ç–∞</label>
          <input type="file" @change="pick('student_pin_doc',$event)" accept=".jpg,.jpeg,.pdf" />
        </div>
        <div>
          <label>–ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞ —Ä–æ–¥–∏—Ç–µ–ª—è/–ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è</label>
          <input type="file" @change="pick('guardian_passport',$event)" accept=".jpg,.jpeg,.pdf" />
          <label>–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞</label>
          <input type="file" @change="pick('medical_certificate',$event)" accept=".jpg,.jpeg,.pdf" />
        </div>
      </div>

      <div class="actions">
        <button @click="step=1" class="secondary">‚Üê –ù–∞–∑–∞–¥</button>
        <button @click="submitAll" :disabled="saving">{{ saving ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å' }}</button>
      </div>

      <div v-if="error2" class="error">{{ error2 }}</div>
      <div v-if="ok" class="success">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úî</div>
    </div>
  </div>
</template>

<script setup lang="ts">
import api from '../utils/api'
import { ref, onMounted } from 'vue'

const step = ref<1|2>(1)
const error1 = ref(''); const error2 = ref('')
const saving = ref(false); const ok = ref(false)
const student_id = ref<number | null>(null)

// —É—Ä–æ–≤–Ω–∏
const levels = ref<any[]>([])
const level_id = ref<number>(0)
async function loadLevels() {
  try {
    const { data } = await api.get('/levels')
    levels.value = data
  } catch (e) { console.error(e) }
}

// –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–∏–ø–∞ –∑–∞–∫–æ–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è
const guardianType = ref<'parent'|'representative'>('parent')

// –†–æ–¥–∏—Ç–µ–ª—å/–ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å
const g = ref({
  last_name: '', first_name: '', middle_name: '',
  sex: 'female', citizenship: 'KG', pin: '', phone: '',
  address: '', email: '',
})

// –£—á–µ–Ω–∏–∫
const s = ref({
  last_name: '', first_name: '', middle_name: '',
  sex: 'male', citizenship: 'KG', birth_date: '',
  pin: '',
  phone: '', email: '',
  password: '', password_confirmation: '',
  class_letter: ''
})

// –§–æ—Ç–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
const studentPhotoFile = ref<File | null>(null)
const studentPhotoPreview = ref<string>('')

// –§–∞–π–ª—ã
const files = ref<Record<string, File | null>>({
  guardian_application: null,
  birth_certificate: null,
  student_pin_doc: null,
  guardian_passport: null,
  medical_certificate: null,
})

const errors = ref<Record<string,string>>({})
function setFieldError(field: string, msg: string) { errors.value[field] = msg }
function clearErrors() { errors.value = {} }

function pick(key: string, e: Event) {
  const input = e.target as HTMLInputElement
  files.value[key] = (input.files && input.files[0]) || null
}

function handlePhotoChange(e: Event) {
  const input = e.target as HTMLInputElement
  const file = input.files?.[0] || null
  studentPhotoFile.value = file

  if (file) {
    const reader = new FileReader()
    reader.onload = (ev) => {
      studentPhotoPreview.value = ev.target?.result as string
    }
    reader.readAsDataURL(file)
  } else {
    studentPhotoPreview.value = ''
  }
}

function validateClient(): boolean {
  clearErrors()
  // guardian
  if (!g.value.last_name) setFieldError('guardian.last_name','–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ')
  if (!g.value.first_name) setFieldError('guardian.first_name','–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ')
  if (!['male','female'].includes(g.value.sex)) setFieldError('guardian.sex','–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª')
  if (!g.value.citizenship) setFieldError('guardian.citizenship','–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ')
  if (!/^\d{14}$/.test(g.value.pin)) setFieldError('guardian.pin','PIN: 14 —Ü–∏—Ñ—Ä')
  if (!g.value.phone) setFieldError('guardian.phone','–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ')
  if (!g.value.address) setFieldError('guardian.address','–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ')
  if (!g.value.email || !g.value.email.includes('@')) setFieldError('guardian.email','–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email')

  // student
  if (!s.value.last_name) setFieldError('student.last_name','–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ')
  if (!s.value.first_name) setFieldError('student.first_name','–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ')
  if (!s.value.pin || !/^\d{14}$/.test(s.value.pin)) {
    setFieldError('student.pin','PIN —É—á–µ–Ω–∏–∫–∞: —Ä–æ–≤–Ω–æ 14 —Ü–∏—Ñ—Ä')
  }
  if (!['male','female'].includes(s.value.sex)) setFieldError('student.sex','–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª')
  if (!s.value.citizenship) setFieldError('student.citizenship','–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ')
  if (!s.value.birth_date) setFieldError('student.birth_date','–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ')
  if (!level_id.value) setFieldError('student.level_id','–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å (–∫–ª–∞—Å—Å)')
  if (!s.value.password) setFieldError('student.password','–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å')
  if (s.value.password !== s.value.password_confirmation) setFieldError('student.password_confirmation','–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç')

  return Object.keys(errors.value).length === 0
}


// –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —à–∞–≥ 2
async function goStep2() {
  error1.value = ''
  try {
    if (!validateClient()) {
      throw new Error('–ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ')
    }
    // –ø—Ä–µ—Ñ–ª–∞–π—Ç: —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ 422/200 (204)
    const payload = {
      guardian_type: guardianType.value,
      guardian: g.value,
      student: { ...s.value, level_id: level_id.value }
    }
    await api.post('/auth/register-student-validate', payload) // 204 No Content

    step.value = 2 // —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –æ–¥–æ–±—Ä–∏–ª
  } catch (e:any) {
    // —Ä–∞—Å–ø–∞—Ä—Å–∏–º 422 –æ—Ç Laravel
    if (e?.status === 422 && e?.data?.errors) {
      for (const [field, msgs] of Object.entries(e.data.errors)) {
        setFieldError(String(field), (msgs as string[]).join(', '))
      }
      error1.value = '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π'
    } else {
      error1.value = e?.data?.message || e?.message || '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏'
    }
  }
}


// –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ñ–∞–π–ª–æ–≤
async function submitAll() {
  error2.value = ''; ok.value = false; saving.value = true
  try {
    // –°–æ–±–∏—Ä–∞–µ–º FormData: –∏ –¥–∞–Ω–Ω—ã–µ —à–∞–≥–∞ 1, –∏ —Ñ–∞–π–ª—ã
    const fd = new FormData()

    // guardian[...]
    Object.entries(g.value).forEach(([k,v]) => {
      if (v !== undefined && v !== null) fd.append(`guardian[${k}]`, String(v))
    })
    fd.append('guardian_type', guardianType.value)

    // student[...]
    const studentPayload = { ...s.value, level_id: level_id.value }
    Object.entries(studentPayload).forEach(([k,v]) => {
      if (v !== undefined && v !== null) fd.append(`student[${k}]`, String(v))
    })

    // —Ñ–∞–π–ª—ã
    for (const [k,v] of Object.entries(files.value)) {
      if (v) fd.append(k, v as Blob)
    }

    // —Ñ–æ—Ç–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
    if (studentPhotoFile.value) {
      fd.append('student_photo', studentPhotoFile.value)
    }

    const { data } = await api.post('/auth/register-student', fd, {
      headers: { 'Content-Type': 'multipart/form-data' }
    })

    ok.value = true
    // –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ —Å–æ—Ö—Ä–∞–Ω–∏–º data.student_id
    // student_id.value = data.student_id
  } catch (e:any) {
    if (e?.status === 422 && e?.data?.errors) {
      // –µ—Å–ª–∏ –≤–Ω–µ–∑–∞–ø–Ω–æ —É–ø–∞–ª–∏ –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—è—Ö/—Ñ–∞–π–ª–∞—Ö ‚Äî –≤–µ—Ä–Ω—ë–º—Å—è –Ω–∞ —à–∞–≥ 1 –∏–ª–∏ –ø–æ–∫–∞–∂–µ–º –Ω–∞–¥ —Ñ–æ—Ä–º–æ–π
      const messages = []
      for (const [field, msgs] of Object.entries(e.data.errors)) {
        messages.push(`${field}: ${(msgs as string[]).join(', ')}`)
      }
      error2.value = messages.join('\n')
    } else {
      error2.value = e?.data?.message || e?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ'
    }
  } finally {
    saving.value = false
  }
}



onMounted(loadLevels)
</script>

<style scoped>
.card { padding:12px; border:1px solid #eee; border-radius:8px; }
.steps { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
.step { display:flex; align-items:center; gap:6px; padding:8px 12px; border-radius:999px; background:#f1f1f1; color:#555; }
.step.active { background:#dceeff; color:#0a4ea6; font-weight:600; }
.line { flex:1; height:2px; background:#eee; }
.radio-row { display:flex; gap:16px; margin:6px 0 10px; }
.row-two { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.actions { margin-top: 12px; display:flex; gap:8px; }
.secondary { background:#eee; }
.help { color:#666; }
.error { color:#b00020; white-space: pre-wrap; margin-top:8px; }
.success { color:#0a7f2e; margin-top:8px; }
</style>
